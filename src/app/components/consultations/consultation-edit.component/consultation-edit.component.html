
<div *ngIf="!loading; else loadingTpl">
  <h2 class="text-xl font-semibold text-blue-700 mb-4">
    {{ isNew ? 'Add Consultation' : 'Edit Consultation' }}
  </h2>

  <form [formGroup]="form" (ngSubmit)="save()" class="space-y-4">
    <div class="grid grid-cols-2 gap-4">

      <!-- ✅ PATIENT SEARCH BAR -->
      <div class="relative">
        <label class="block text-gray-700 mb-1">Patient</label>
        <input
          type="text"
          [value]="searchTerm"
          (input)="onSearch($any($event.target).value)"
          placeholder="Search patient by name or phone..."
          class="border p-2 rounded w-full"
          autocomplete="off"
        />

        <!-- Suggestions dropdown -->
        <ul
          *ngIf="filteredPatients.length > 0"
          class="absolute bg-white border rounded w-full shadow mt-1 max-h-48 overflow-y-auto z-10"
        >
          <li
            *ngFor="let p of filteredPatients"
            (click)="selectPatient(p)"
            class="px-3 py-2 hover:bg-blue-100 cursor-pointer"
          >
            {{ p.patientName }} — <span class="text-gray-500 text-sm">{{ p.phone }}</span>
          </li>
        </ul>

        <button
          type="button"
          (click)="openAddPatient()"
          class="absolute right-2 top-2 bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded"
        >
          + Add
        </button>
      </div>

      <!-- ✅ Department Dropdown -->
      <div>
        <label class="block text-gray-700 mb-1">Department</label>
        <select formControlName="departmentId" class="border p-2 rounded w-full">
          <option value="">Select Department</option>
          <option *ngFor="let dep of departments" [value]="dep.departmentId">
            {{ dep.departmentName }}
          </option>
        </select>
      </div>

      <!-- ✅ Doctor Dropdown (auto-loads from selected department) -->
      <div>
        <label class="block text-gray-700 mb-1">Doctor</label>
        <select formControlName="doctorId" class="border p-2 rounded w-full">
          <option value="">Select Doctor</option>
          <option *ngFor="let d of doctors" [value]="d.doctorId">
            {{ d.doctorName }}
          </option>
        </select>
      </div>

      <!-- ✅ Service Dropdown (auto-fills Fee) -->
      <div>
        <label class="block text-gray-700 mb-1">Service</label>
        <select formControlName="serviceId" class="border p-2 rounded w-full">
          <option value="">Select Service</option>
          <option *ngFor="let s of services" [value]="s.serviceId">
            {{ s.serviceName }}
          </option>
        </select>
      </div>
    </div>

    <!-- ✅ Fee -->
    <div>
      <label class="block text-gray-700 mb-1">Fee</label>
      <input formControlName="fee" type="number" class="border p-2 rounded w-full" />
    </div>

    <!-- ✅ Notes -->
    <div>
      <label class="block text-gray-700 mb-1">Notes</label>
      <textarea formControlName="notes" rows="3" class="border p-2 rounded w-full"></textarea>
    </div>

    <!-- ✅ Action Buttons -->
    <div class="flex justify-end gap-3 mt-6">
      <button
        type="button"
        (click)="cancel()"
        class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded"
      >
        Cancel
      </button>
      <button
        type="submit"
        [disabled]="form.invalid"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded"
      >
        Save
      </button>
    </div>
  </form>

  <!-- ✅ Add New Patient Modal -->
  <div
    *ngIf="showAddPatientModal"
    class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50"
  >
    <div class="bg-white rounded-lg shadow-lg w-96 p-6">
      <h3 class="text-lg font-semibold mb-4 text-blue-700">Add New Patient</h3>

      <div class="space-y-3">
        <input
          [(ngModel)]="newPatient.patientName"
          placeholder="Patient Name"
          class="border p-2 rounded w-full"
        />
        <input
          [(ngModel)]="newPatient.age"
          type="number"
          placeholder="Age"
          class="border p-2 rounded w-full"
        />
        <select
          [(ngModel)]="newPatient.gender"
          class="border p-2 rounded w-full"
        >
          <option value="">Select Gender</option>
          <option value="Male">Male</option>
          <option value="Female">Female</option>
        </select>
        <input
          [(ngModel)]="newPatient.phone"
          type="tel"
          maxlength="10"
          pattern="[0-9]*"
          placeholder="Phone"
          class="border p-2 rounded w-full"
        />
        <textarea
          [(ngModel)]="newPatient.address"
          rows="2"
          placeholder="Address"
          class="border p-2 rounded w-full"
        ></textarea>
      </div>

      <div class="flex justify-end gap-2 mt-5">
        <button
          (click)="cancelNewPatient()"
          class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded"
        >
          Cancel
        </button>
        <button
          (click)="saveNewPatient()"
          class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded"
        >
          Save
        </button>
      </div>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="text-center text-gray-500">Loading...</div>
</ng-template>
